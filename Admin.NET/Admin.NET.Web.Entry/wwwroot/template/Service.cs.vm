// Admin.NET é¡¹ç›®çš„ç‰ˆæƒã€å•†æ ‡ã€ä¸“åˆ©å’Œå…¶ä»–ç›¸å…³æƒåˆ©å‡å—ç›¸åº”æ³•å¾‹æ³•è§„çš„ä¿æŠ¤ã€‚ä½¿ç”¨æœ¬é¡¹ç›®åº”éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œè®¸å¯è¯çš„è¦æ±‚ã€‚
//
// æœ¬é¡¹ç›®ä¸»è¦éµå¾ª MIT è®¸å¯è¯å’Œ Apache è®¸å¯è¯ï¼ˆç‰ˆæœ¬ 2.0ï¼‰è¿›è¡Œåˆ†å‘å’Œä½¿ç”¨ã€‚è®¸å¯è¯ä½äºæºä»£ç æ ‘æ ¹ç›®å½•ä¸­çš„ LICENSE-MIT å’Œ LICENSE-APACHE æ–‡ä»¶ã€‚
//
// ä¸å¾—åˆ©ç”¨æœ¬é¡¹ç›®ä»äº‹å±å®³å›½å®¶å®‰å…¨ã€æ‰°ä¹±ç¤¾ä¼šç§©åºã€ä¾µçŠ¯ä»–äººåˆæ³•æƒç›Šç­‰æ³•å¾‹æ³•è§„ç¦æ­¢çš„æ´»åŠ¨ï¼ä»»ä½•åŸºäºæœ¬é¡¹ç›®äºŒæ¬¡å¼€å‘è€Œäº§ç”Ÿçš„ä¸€åˆ‡æ³•å¾‹çº çº·å’Œè´£ä»»ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼

using Admin.NET.Core.Service;
using Microsoft.AspNetCore.Http;
using Furion.DatabaseAccessor;
using Furion.FriendlyException;
using Mapster;
using SqlSugar;
using System.ComponentModel;
using System.ComponentModel.DataAnnotations;
using @(Model.NameSpace).Entity;
namespace @(Model.NameSpace);

/// <summary>
/// @(Model.BusName)æœåŠ¡ ğŸ§©
/// </summary>
[ApiDescriptionSettings(@(Model.ProjectLastName)Const.GroupName, Order = 100)]
public partial class @(Model.ClassName)Service : IDynamicApiController, ITransient
{
    private readonly SqlSugarRepository<@(Model.ClassName)> _@(Model.LowerClassName)Rep;
    @foreach(var kv in Model.InjectServiceMap) {
    @:private readonly @(kv.Key) _@(kv.Value);
    }

    public @(Model.ClassName)Service(SqlSugarRepository<@(Model.ClassName)> @(Model.LowerClassName)Rep@(Model.InjectServiceArgs))
    {
        _@(Model.LowerClassName)Rep = @(Model.LowerClassName)Rep;
        @foreach(var kv in Model.InjectServiceMap) {
        @:_@(kv.Value) = @(kv.Value);
        }
    }

    /// <summary>
    /// åˆ†é¡µæŸ¥è¯¢@(Model.BusName) ğŸ”–
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("åˆ†é¡µæŸ¥è¯¢@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Page"), HttpPost]
    public async Task<SqlSugarPagedList<@(Model.ClassName)Output>> Page(Page@(Model.ClassName)Input input)
    {
        input.Keyword = input.Keyword?.Trim();
        var query = _@(Model.LowerClassName)Rep.AsQueryable()
    @{
          string joinTableName = "u";
          var queryFields = Model.TableField.Where(u => u.WhetherQuery == "Y");
          // å…³é”®å­—æ¨¡ç³ŠæŸ¥è¯¢
          if (queryFields.Any(u => u.QueryType == "like")) {
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.Keyword), u => @string.Join(" || ", queryFields.Where(u => u.QueryType == "like").Select(col => $"u.{col.PropertyName}.Contains(input.Keyword)")))
          }

          // å•å­—æ®µæ¨¡ç³ŠæŸ¥è¯¢
          foreach(var column in queryFields.Where(u => u.QueryType == "like")) {
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.@(column.PropertyName)), u => u.@(column.PropertyName).Contains(input.@(column.PropertyName).Trim()))
          }

          // å­—æ®µç»„åˆæŸ¥è¯¢
          foreach(var column in queryFields.Where(u => u.QueryType != "like")) {
            if (column.NetType.TrimEnd('?') == "string") {
            @:.WhereIF(!string.IsNullOrWhiteSpace(input.@(column.PropertyName)), u => u.@(column.PropertyName) == input.@(column.PropertyName))
            } else if (column.NetType.TrimEnd('?') == "int" || column.NetType.TrimEnd('?') == "long") {
            @:.WhereIF(input.@(column.PropertyName) != null, u => u.@(column.PropertyName) @(column.QueryType) input.@(column.PropertyName))
            } else if (column.NetType.TrimEnd('?').EndsWith("Enum")) {
            @:.WhereIF(input.@(column.PropertyName).HasValue, u => u.@(column.PropertyName) == input.@(column.PropertyName))
            } else if (column.NetType.TrimEnd('?') == "DateTime" && column.QueryType == "~") {
            @:.WhereIF(input.@(column.PropertyName)Range?.Length == 2, u => u.@(column.PropertyName) >= input.@(column.PropertyName)Range[0] && u.@(column.PropertyName) <= input.@(column.PropertyName)Range[1])
            } else if (column.NetType.TrimEnd('?').EndsWith("bool")) {
            @:.WhereIF(input.@(column.PropertyName).HasValue, u => u.@(column.PropertyName) == input.@(column.PropertyName))
            }

          }
          // è”è¡¨
          if (Model.HasJoinTable) {
            foreach (var column in Model.TableField.Where(u => u.EffectType == "ForeignKey" || u.EffectType == "ApiTreeSelector")){
            joinTableName += ", " + column.LowerPropertyNameTrimEndId;
            @:.LeftJoin<@column.FkEntityName>((@joinTableName) => u.@(column.PropertyName) == @(column.LowerPropertyNameTrimEndId).@(column.FkLinkColumnName))
          }
            // æŸ¥è¯¢åˆ—è¡¨
            @:.Select((@joinTableName) => new @(Model.ClassName)Output
            @:{
            foreach (var column in Model.TableField) {
                if(column.NetType.TrimEnd('?').EndsWith("Enum")) {
                @:@(column.PropertyName) = (@(column.NetType))u.@(column.PropertyName),
                }else{
                @:@(column.PropertyName) = u.@(column.PropertyName),
                }
                if (column.EffectType == "ForeignKey" || column.EffectType == "ApiTreeSelector") {
                @:@(column.ExtendedPropertyName) = @column.GetDisplayColumn(column.LowerPropertyNameTrimEndId),
                }
            }
            @:});
         } else {
            // æ— è”è¡¨
            @:.Select<@(Model.ClassName)Output>();
         }
    }
		return await query.OrderBuilder(input).ToPagedListAsync(input.Page, input.PageSize);
    }

    /// <summary>
    /// è·å–@(Model.BusName)è¯¦æƒ… â„¹ï¸
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("è·å–@(Model.BusName)è¯¦æƒ…")]
    [ApiDescriptionSettings(Name = "Detail"), HttpGet]
    public async Task<@(Model.ClassName)> Detail([FromQuery] QueryById@(Model.ClassName)Input input)
    {
        return await _@(Model.LowerClassName)Rep.GetFirstAsync(u => @Model.PrimaryKeysFormat(" && ", "u.{0} == input.{0}"));
    }

    /// <summary>
    /// å¢åŠ @(Model.BusName) â•
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("å¢åŠ @(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Add"), HttpPost]
    public async Task<long> Add(Add@(Model.ClassName)Input input)
    {
        var entity = input.Adapt<@(Model.ClassName)>();
        @foreach (var config in Model.TableUniqueConfigList) {
        @:if (await _@(Model.LowerClassName)Rep.IsAnyAsync(u => @(string.Join(" && ", @config.Columns.Select(x => $"u.{x} != null && u.{x} == input.{x}"))))) throw Oops.Oh("@(config.Message)å·²å­˜åœ¨");
        }
        return await _@(Model.LowerClassName)Rep.InsertAsync(entity) ? entity.Id : 0;
    }

    /// <summary>
    /// æ›´æ–°@(Model.BusName) âœï¸
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("æ›´æ–°@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Update"), HttpPost]
    public async Task Update(Update@(Model.ClassName)Input input)
    {
        @{
        var primaryKeyWhere = Model.PrimaryKeysFormat(" && ", "u.{0} != input.{0}");
        foreach (var config in Model.TableUniqueConfigList) {
        @:if (await _@(Model.LowerClassName)Rep.IsAnyAsync(u => @primaryKeyWhere && @config.Format(" && ", "u.{0} != null && u.{0} == input.{0}"))) throw Oops.Oh("@(config.Message)å·²å­˜åœ¨");
        }
        }
        var entity = input.Adapt<@(Model.ClassName)>();
        await _@(Model.LowerClassName)Rep.AsUpdateable(entity)
        @if (Model.IgnoreUpdateFieldList.Count > 0) {
        @:.IgnoreColumns(u => new {
        foreach (var column in Model.IgnoreUpdateFieldList) {
            @:u.@(column.PropertyName),
        }
        @:})
        }
        .ExecuteCommandAsync();
    }

    /// <summary>
    /// åˆ é™¤@(Model.BusName) âŒ
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("åˆ é™¤@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "Delete"), HttpPost]
    public async Task Delete(Delete@(Model.ClassName)Input input)
    {
        var entity = await _@(Model.LowerClassName)Rep.GetFirstAsync(u => @Model.PrimaryKeysFormat(" && ", "u.{0} == input.{0}")) ?? throw Oops.Oh(ErrorCodeEnum.D1002); 
@{ 
    @if(Model.TableField.Where(x => x.ColumnName == "IsDelete").Any())
    {
        @:await _@(Model.LowerClassName)Rep.FakeDeleteAsync(entity);   //å‡åˆ é™¤
    }
    else{
        @:await _@(Model.LowerClassName)Rep.DeleteAsync(entity);   //çœŸåˆ é™¤ 
    }
}  
    }

    /// <summary>
    /// æ‰¹é‡åˆ é™¤@(Model.BusName) âŒ
    /// </summary>
    /// <param name="input"></param>
    /// <returns></returns>
    [DisplayName("æ‰¹é‡åˆ é™¤@(Model.BusName)")]
    [ApiDescriptionSettings(Name = "BatchDelete"), HttpPost]
    public async Task<int> BatchDelete([Required(ErrorMessage = "ä¸»é”®åˆ—è¡¨ä¸èƒ½ä¸ºç©º")]List<Delete@(Model.ClassName)Input> input)
    {
        var exp = Expressionable.Create<@(Model.ClassName)>();
        foreach (var row in input) exp = exp.Or(it => @Model.PrimaryKeysFormat(" && ", "it.{0} == row.{0}"));
        var list = await _@(Model.LowerClassName)Rep.AsQueryable().Where(exp.ToExpression()).ToListAsync();
@{ 
    @if(Model.TableField.Where(x => x.ColumnName == "IsDelete").Any())
    {
        @:return await _@(Model.LowerClassName)Rep.FakeDeleteAsync(list);   //å‡åˆ é™¤
    }
    else{ 
        @:return await _@(Model.LowerClassName)Rep.Context.Deleteable(list).ExecuteCommandAsync();   //çœŸåˆ é™¤--è¿”å›å—å½±å“çš„è¡Œæ•°
    }
}  
    }
    @if (Model.HasSetStatus) {
    @:
    @:/// <summary>
    @:/// è®¾ç½®@(Model.BusName)çŠ¶æ€ ğŸš«
    @:/// </summary>
    @:/// <param name="input"></param>
    @:/// <returns></returns>
    @:[DisplayName("è®¾ç½®@(Model.BusName)çŠ¶æ€")]
    @:[ApiDescriptionSettings(Name = "SetStatus"), HttpPost]
    @:public async Task Set@(Model.ClassName)Status(Set@(Model.ClassName)StatusInput input)
    @:{
        @:await _@(Model.LowerClassName)Rep.AsUpdateable().SetColumns(u => u.Status, input.Status).Where(u => @Model.PrimaryKeysFormat(" && ", "u.{0} == input.{0}")).ExecuteCommandAsync();
    @:}
    }
    @foreach (var column in Model.UploadFieldList) {
    @:
    @:/// <summary>
    @:/// ä¸Šä¼ @(column.ColumnComment) â¬†ï¸
    @:/// </summary>
    @:/// <param name="file"></param>
    @:/// <returns></returns>
    @:[DisplayName("ä¸Šä¼ @(column.ColumnComment)")]
    @:[ApiDescriptionSettings(Name = "Upload@(column.PropertyName)"), HttpPost]
    @:public async Task<SysFile> Upload@(column.PropertyName)([Required] IFormFile file)
    @:{
        @:return await _sysFileService.UploadFile(new UploadFileInput { File = file },"upload/@(Model.ClassName)/@(column.PropertyName)"); 
    @:}
    }
    @if (Model.DropdownFieldList.Count > 0) {
    @:
    @:/// <summary>
    @:/// è·å–ä¸‹æ‹‰åˆ—è¡¨æ•°æ® ğŸ”–
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("è·å–ä¸‹æ‹‰åˆ—è¡¨æ•°æ®")]
    @:[ApiDescriptionSettings(Name = "DropdownData"), HttpPost]
    @:public async Task<Dictionary<string, dynamic>> DropdownData(DropdownData@(Model.ClassName)Input input)
    @:{
        foreach (var column in Model.DropdownFieldList) {
        @:var @(column.LowerPropertyName)Data = await _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>()
            if (column.EffectType != "ApiTreeSelector") {
            @:.InnerJoinIF<@Model.ClassName>(input.FromPage, (u, r) => u.@(column.FkLinkColumnName) == r.@(column.PropertyName))
            }
            if (column.EffectType != "ApiTreeSelector") {
            @:.Select(u => new {
                @:Value = u.@(column.FkLinkColumnName),
                @:Label = @column.GetDisplayColumn("u")
            @:}).ToListAsync();
            } else {
            @:.Select(u => new Tree@(column.PropertyNameTrimEndId)Output {
                @:Value = u.@(column.FkLinkColumnName),
                @:Label = @column.GetDisplayColumn("u")
            @:}, true).ToTreeAsync(u => u.Children, u => u.@(column.PidColumn), @(column.WhetherRequired == "Y" ? "0" : "null"));
            }
        }
        @:return new Dictionary<string, dynamic>
        @:{
            foreach (var column in Model.DropdownFieldList) {
            @:{ "@(column.LowerPropertyName)", @(column.LowerPropertyName)Data },
            }
        @:};
    @:}
    }
    @if (Model.ImportFieldList.Count > 0) {
    @:
    @:/// <summary>
    @:/// å¯¼å‡º@(Model.BusName)è®°å½• ğŸ”–
    @:/// </summary>
    @:/// <param name="input"></param>
    @:/// <returns></returns>
    @:[DisplayName("å¯¼å‡º@(Model.BusName)è®°å½•")]
    @:[ApiDescriptionSettings(Name = "Export"), HttpPost, NonUnify]
    @:public async Task<IActionResult> Export(Page@(Model.ClassName)Input input)
    @:{
        @:var list = (await Page(input)).Items?.Adapt<List<Export@(Model.ClassName)Output>>() ?? new();
        @:if (input.SelectKeyList?.Count > 0) list = list.Where(x => input.SelectKeyList.Contains(x.@(Model.PrimaryKeyFieldList.First().PropertyName))).ToList();
        var dictFields = Model.TableField.Where(x => x.WhetherImport == "Y" && x.EffectType == "DictSelector") ?? default;
        foreach (var column in dictFields) {
        @:var @(column.LowerPropertyName)DictMap = _sysDictTypeService.GetDataList(new GetDataDictTypeInput { Code = "@(column.DictTypeCode)" }).Result.ToDictionary(x => x.Value, x => x.Label);
        }
        if (dictFields.Count() > 0) {
        @:list.ForEach(e => {
        foreach (var column in dictFields) {
            @:e.@(column.ExtendedPropertyName) = @(column.LowerPropertyName)DictMap.GetValueOrDefault(e.@(column.PropertyName) ?? "", e.@(column.PropertyName));
        }
        @:});
        }
        @:return ExcelHelper.ExportTemplate(list, "@(Model.BusName)å¯¼å‡ºè®°å½•");
    @:}
    @:
    @:/// <summary>
    @:/// ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿ â¬‡ï¸
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("ä¸‹è½½@(Model.BusName)æ•°æ®å¯¼å…¥æ¨¡æ¿")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpGet, NonUnify]
    @:public IActionResult DownloadTemplate()
    @:{
        var fieldsList = Model.ImportFieldList.Where(u => u.EffectType == "ForeignKey" || u.EffectType == "ApiTreeSelector").ToList();
        if (fieldsList.Any()) {
        @:return ExcelHelper.ExportTemplate(new List<Export@(Model.ClassName)Output>(), "@(Model.BusName)å¯¼å…¥æ¨¡æ¿", (_, info) =>
        @:{
            foreach (var column in fieldsList) {
            var columnList = column.FkDisplayColumnList.Select(n => $"{{u.{n}}}").ToList();
            @:if (nameof(Export@(Model.ClassName)Output.@column.ExtendedPropertyName) == info.Name) return _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Select(u => $"@(string.Join("-", columnList))").Distinct().ToList();
            }
            @:return null;
        @:});
        } else {
        @:return ExcelHelper.ExportTemplate(new List<Export@(Model.ClassName)Output>(), "@(Model.BusName)å¯¼å…¥æ¨¡æ¿");
        }
    @:}
    @:
    @:private static readonly object _@(Model.LowerClassName)ImportLock = new object();
    @:/// <summary>
    @:/// å¯¼å…¥@(Model.BusName)è®°å½• ğŸ’¾
    @:/// </summary>
    @:/// <returns></returns>
    @:[DisplayName("å¯¼å…¥@(Model.BusName)è®°å½•")]
    @:[ApiDescriptionSettings(Name = "Import"), HttpPost, NonUnify, UnitOfWork]
    @:public IActionResult ImportData([Required] IFormFile file)
    @:{
        @:lock (_@(Model.LowerClassName)ImportLock)
        @:{
            var dictTableField = Model.TableField.Where(x => x.WhetherImport == "Y" && x.EffectType == "DictSelector") ?? default;
            foreach (var column in dictTableField){
            @:var @(column.LowerPropertyName)DictMap = _sysDictTypeService.GetDataList(new GetDataDictTypeInput { Code = "@(column.DictTypeCode)" }).Result.ToDictionary(x => x.Label!, x => x.Value);
            }

            @:var stream = ExcelHelper.ImportData<Import@(Model.ClassName)Input, @(Model.ClassName)>(file, (list, markerErrorAction) =>
            @:{
                @:_sqlSugarClient.Utilities.PageEach(list, 2048, pageItems =>
                @:{
                    foreach (var column in Model.ImportFieldList.Where(u => u.EffectType == "ForeignKey" || u.EffectType == "ApiTreeSelector")) {
                    @:// é“¾æ¥ @(column.ColumnComment)
                    @:var @(column.LowerPropertyName)LabelList = pageItems.Where(x => x.@column.ExtendedPropertyName != null).Select(x => x.@column.ExtendedPropertyName).Distinct().ToList();
                    @:if (@(column.LowerPropertyName)LabelList.Any()) {
                        var columnList = column.FkDisplayColumnList.Select(n => $"{{u.{n}}}").ToList();
                        @:var @(column.LowerPropertyName)LinkMap = _@(Model.LowerClassName)Rep.Context.Queryable<@(column.FkEntityName)>().Where(u => @(column.LowerPropertyName)LabelList.Contains($"@(string.Join("-", columnList))")).ToList().ToDictionary(u => $"@(string.Join("-", columnList))", u => u.@(column.FkLinkColumnName)  as @(column.NetType.TrimEnd('?') == "long" ? "long?": column.NetType));
                        @:pageItems.ForEach(e => {
                            @:e.@(column.PropertyName) = @(column.LowerPropertyName)LinkMap.GetValueOrDefault(e.@column.ExtendedPropertyName ?? "");
                            @:if (e.@(column.PropertyName) == null) e.Error = "@(column.ColumnComment)é“¾æ¥å¤±è´¥";
                        @:});
                    @:}
                    }

                    if (dictTableField.Any()) {
                    @:
                    @:// æ˜ å°„å­—å…¸å€¼
                    @:foreach(var item in pageItems) {
                        @:System.Text.StringBuilder sbError = new System.Text.StringBuilder();
                        foreach (var column in dictTableField) {
                        @:if (!string.IsNullOrWhiteSpace(item.@(column.ExtendedPropertyName))) {
                            @:item.@(column.PropertyName) = @(column.LowerPropertyName)DictMap.GetValueOrDefault(item.@(column.ExtendedPropertyName));
                            @:if (item.@(column.PropertyName) == null) sbError.AppendLine("@(column.ColumnComment)å­—å…¸æ˜ å°„å¤±è´¥");
                        @:}
                        }
                        @:item.Error = sbError.ToString();
                    @:}
                    }

                    @:
                    @:// æ ¡éªŒå¹¶è¿‡æ»¤å¿…å¡«åŸºæœ¬ç±»å‹ä¸ºnullçš„å­—æ®µ
                    @:var rows = pageItems.Where(x => {
                        @:if (!string.IsNullOrWhiteSpace(x.Error)) return false;
                        foreach (var column in Model.ImportFieldList.Where(x => x.WhetherRequired == "Y" && Regex.IsMatch(x.NetType, "(int|long|double|float|bool|Enum[?]?)"))){
                        @:if (x.@(column.PropertyName) == null){
                            @:x.Error = "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º";
                            @:return false;
                        @:}
                        }
                        @:return true;
                    @:}).Adapt<List<@(Model.ClassName)>>();
                                   
                    @{var updateFields = new List<string>();}  
                    @:
                    @:var storageable = _@(Model.LowerClassName)Rep.Context.Storageable(rows)
                        foreach (var column in Model.ImportFieldList){
                        if (column.WhetherImport == "Y"){
                        updateFields.Add(column.PropertyName);
                        }
                        if (column.WhetherRequired == "Y"){
                        if(column.NetType.TrimEnd('?') == "string"){
                        @:.SplitError(it => string.IsNullOrWhiteSpace(it.Item.@(column.PropertyName)), "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        } else if(column.NetType.EndsWith('?') == true){
                        @:.SplitError(it => it.Item.@(column.PropertyName) == null, "@(column.ColumnComment)ä¸èƒ½ä¸ºç©º")
                        }}
                        if (column.NetType?.TrimEnd('?') == "string" && column.ColumnLength > 0){
                        @:.SplitError(it => it.Item.@(column.PropertyName)?.Length > @(column.ColumnLength), "@(column.ColumnComment)é•¿åº¦ä¸èƒ½è¶…è¿‡@(column.ColumnLength)ä¸ªå­—ç¬¦")
                        }}
                        if(Model.TableUniqueConfigList.Count>0){
                        foreach (var config in Model.TableUniqueConfigList) {
                        @:.WhereColumns(it => new { @config.Format(", ", "it.{0}") })
                        }
                        @:.SplitInsert(it=> !it.Any())
                        @:.SplitUpdate(it=> it.Any())
                        }else{                        
                        @:.SplitInsert(_=> true) // æ²¡æœ‰è®¾ç½®å”¯ä¸€é”®ä»£è¡¨æ’å…¥æ‰€æœ‰æ•°æ®
                        }
                        @:.ToStorage();
                    @:
                    @:storageable.AsInsertable.ExecuteCommand();// ä¸å­˜åœ¨æ’å…¥
                    @:storageable.AsUpdateable.UpdateColumns(it => new
                    @:{
                    @foreach (var field in updateFields)
                    {
                    @:    it.@(field),
                    }
                    @:}).ExecuteCommand();// å­˜åœ¨æ›´æ–°
                    @:
                    @:// æ ‡è®°é”™è¯¯ä¿¡æ¯
                    @:markerErrorAction.Invoke(storageable, pageItems, rows);
                @:});
            @:});
            @:
            @:return stream;
        @:}
    @:}
    }
}
